<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>Grafana + Loki + Promtail + Prometheus + AlertManager 搭建附带钉钉通知的日志收集、主机监控系统</title><meta name="description" content="一个中年大叔"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no,initial-scale=1"><link rel="icon" href="https://cdn.free.gd/assets/img/avatar.26ljofvr7k.avif"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="//unpkg.com/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><script src="//unpkg.com/prismjs@1.29.0/components/prism-core.min.js"></script><script src="/js/prismjs.js"></script><meta name="description" content="导读目前学校在申请二级等保认证，这其中就有一项日志记录，而学校因为历史原因，所使用的业务很繁杂，系统也多样化，我来了后虽然改了一部分，但依然因为费用的原因，导致没有专门的日志系统，这也就导致在认证时采集日志的工作变得极为复杂。
于是乎，为了解决这一问题，心里就在此浮现了搭建专用的日志采集系统的想法，正好之前有一台服务器被我改成了 Proxmox，部分小业务一直跑在上面，于是这次就在这台服务器上开个虚拟机，专门用来采集日志。


环境介绍本次搭建环境如下：



序号
IP地址
操作系统
安装软件 ｜ 用途



1
192.168.10.1
Alpine
全套


2
192.168.10.2
Ubuntu
Promtail + Node Exporter


主服务器搭建系统准备本着资源最小化的原则，直接.."><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="康诺'S 小屋" type="application/atom+xml"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">康诺's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Grafana + Loki + Promtail + Prometheus + AlertManager 搭建附带钉钉通知的..</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">主页</a></h3><h3 class="is-inline-block"><a href="/categories">分类</a></h3><h3 class="is-inline-block"><a href="/tags">标签</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">主页</a></h3><h3 class="is-inline-block"><a href="/categories">分类</a></h3><h3 class="is-inline-block"><a href="/tags">标签</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E8%AF%BB"><span class="toc-text">导读</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D"><span class="toc-text">环境介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA"><span class="toc-text">主服务器搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%87%86%E5%A4%87"><span class="toc-text">系统准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Grafana-%E6%90%AD%E5%BB%BA"><span class="toc-text">Grafana 搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Loki-%E6%90%AD%E5%BB%BA"><span class="toc-text">Loki 搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus-%E6%90%AD%E5%BB%BA"><span class="toc-text">Prometheus 搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AlertManager-%E6%90%AD%E5%BB%BA"><span class="toc-text">AlertManager 搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A6%E6%90%AD%E5%BB%BA"><span class="toc-text">钉钉告警搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Promtail-%E6%90%AD%E5%BB%BA"><span class="toc-text">Promtail 搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%90%84%E9%A1%B9%E6%9C%8D%E5%8A%A1"><span class="toc-text">启动各项服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%90%AD%E5%BB%BA"><span class="toc-text">客户端搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Promtail-%E6%90%AD%E5%BB%BA-1"><span class="toc-text">Promtail 搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-Exporter-%E6%90%AD%E5%BB%BA"><span class="toc-text">Node Exporter 搭建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E6%9D%BF%E4%BD%BF%E7%94%A8"><span class="toc-text">面板使用</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/%E6%97%A5%E5%BF%97"><i class="tag post-item-tag">日志</i></a><a href="/tags/Grafana"><i class="tag post-item-tag">Grafana</i></a><a href="/tags/Loki"><i class="tag post-item-tag">Loki</i></a><a href="/tags/Promtail"><i class="tag post-item-tag">Promtail</i></a><a href="/tags/Prometheus"><i class="tag post-item-tag">Prometheus</i></a><a href="/tags/AlertManager"><i class="tag post-item-tag">AlertManager</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Grafana + Loki + Promtail + Prometheus + AlertManager 搭建附带钉钉通知的日志收集、主机监控系统</h1><time class="has-text-grey" datetime="2024-12-18T16:09:03.000Z">2024-12-19</time><article class="mt-2 post-content"><h2 id="导读"><a href="#导读" class="headerlink" title="导读"></a>导读</h2><p>目前学校在申请二级等保认证，这其中就有一项日志记录，而学校因为历史原因，所使用的业务很繁杂，系统也多样化，我来了后虽然改了一部分，但依然因为费用的原因，导致没有专门的日志系统，这也就导致在认证时采集日志的工作变得极为复杂。</p><p>于是乎，为了解决这一问题，心里就在此浮现了搭建专用的日志采集系统的想法，正好之前有一台服务器被我改成了 <a target="_blank" rel="noopener" href="https://proxmox.com/en/">Proxmox</a>，部分小业务一直跑在上面，于是这次就在这台服务器上开个虚拟机，专门用来采集日志。</p><span id="more"></span><h2 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h2><p>本次搭建环境如下：</p><table><thead><tr><th align="center">序号</th><th align="center">IP地址</th><th align="center">操作系统</th><th align="center">安装软件 ｜ 用途</th></tr></thead><tbody><tr><td align="center">1</td><td align="center">192.168.10.1</td><td align="center">Alpine</td><td align="center">全套</td></tr><tr><td align="center">2</td><td align="center">192.168.10.2</td><td align="center">Ubuntu</td><td align="center">Promtail + Node Exporter</td></tr></tbody></table><h2 id="主服务器搭建"><a href="#主服务器搭建" class="headerlink" title="主服务器搭建"></a>主服务器搭建</h2><h3 id="系统准备"><a href="#系统准备" class="headerlink" title="系统准备"></a>系统准备</h3><p>本着资源最小化的原则，直接采用了 <a target="_blank" rel="noopener" href="https://alpinelinux.org/">Alpine</a> 操作系统，只有几兆的大小，资源占用那叫一个小啊。</p><p>同时，将几个软件整合在整个系统中，使用 <a target="_blank" rel="noopener" href="https://grafana.com/">Grafana</a> 作为面板查看各项数据，<a target="_blank" rel="noopener" href="https://github.com/grafana/loki">Loki</a> 作为日志收集系统，<a target="_blank" rel="noopener" href="https://prometheus.io/">Prometheus</a> 主机监控，<a target="_blank" rel="noopener" href="https://github.com/prometheus/alertmanager">AlertManager</a> 用于系统告警，<a target="_blank" rel="noopener" href="https://prometheus.io/">Prometheus</a> 的第三方钉钉插件用于对接钉钉报警。</p><p>系统正常开启并更新后，执行命令安装必要组件：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apk <span class="token function">add</span> <span class="token function">curl</span> <span class="token function">wget</span> libc6-compat<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>创建必要的数据存储目录：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/grafana
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/loki/chunks
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/loki/rules
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/prometheus
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/alertmanager
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/dingtalk
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/promtail
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /opt/loki
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /opt/promtail<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建各服务所需的用户，这里不为 <a target="_blank" rel="noopener" href="https://github.com/grafana/loki">Promtail</a> 创建用户，是因为 <a target="_blank" rel="noopener" href="https://github.com/grafana/loki">Promtail</a> 在提交日志时，需要提交一些系统日志，使用独立用户会导致因权限问题无法提交：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">addgroup <span class="token parameter variable">-S</span> grafana
addgroup <span class="token parameter variable">-S</span> loki
addgroup <span class="token parameter variable">-S</span> prometheus
addgroup <span class="token parameter variable">-S</span> alertmanager
addgroup <span class="token parameter variable">-S</span> dingtalk
adduser <span class="token parameter variable">-S</span> <span class="token parameter variable">-D</span> <span class="token parameter variable">-H</span> <span class="token parameter variable">-G</span> grafana grafana
adduser <span class="token parameter variable">-S</span> <span class="token parameter variable">-D</span> <span class="token parameter variable">-H</span> <span class="token parameter variable">-G</span> loki loki
adduser <span class="token parameter variable">-S</span> <span class="token parameter variable">-D</span> <span class="token parameter variable">-H</span> <span class="token parameter variable">-G</span> prometheus prometheus
adduser <span class="token parameter variable">-S</span> <span class="token parameter variable">-D</span> <span class="token parameter variable">-H</span> <span class="token parameter variable">-G</span> alertmanager alertmanager
adduser <span class="token parameter variable">-S</span> <span class="token parameter variable">-D</span> <span class="token parameter variable">-H</span> <span class="token parameter variable">-G</span> dingtalk dingtalk<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下载所需各项软件：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /tmp
<span class="token function">wget</span> <span class="token parameter variable">-c</span> https://dl.grafana.com/enterprise/release/grafana-enterprise-11.4.0.linux-amd64.tar.gz
<span class="token function">wget</span> <span class="token parameter variable">-c</span> https://github.com/grafana/loki/releases/download/v3.3.1/loki-linux-amd64.zip
<span class="token function">wget</span> <span class="token parameter variable">-c</span> https://github.com/grafana/loki/releases/download/v3.3.1/promtail-linux-amd64.zip
<span class="token function">wget</span> <span class="token parameter variable">-c</span> https://github.com/prometheus/prometheus/releases/download/v2.53.3/prometheus-2.53.3.linux-amd64.tar.gz
<span class="token function">wget</span> <span class="token parameter variable">-c</span> https://github.com/prometheus/alertmanager/releases/download/v0.27.0/alertmanager-0.27.0.linux-amd64.tar.gz
<span class="token function">wget</span> <span class="token parameter variable">-c</span> https://github.com/timonwong/prometheus-webhook-dingtalk/releases/download/v2.1.0/prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Grafana-搭建"><a href="#Grafana-搭建" class="headerlink" title="Grafana 搭建"></a>Grafana 搭建</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> zxf grafana-enterprise-11.4.0.linux-amd64.tar.gz
<span class="token function">mv</span> grafana-v11.4.0 /opt/grafana

<span class="token function">cat</span> <span class="token operator">></span> /opt/grafana/conf/config.ini <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[paths]
data = /data/grafana/data
logs = /data/grafana/log
plugins = /opt/grafana/plugins
provisioning = /opt/grafana/conf/provisioning
EOF</span>

<span class="token function">cat</span> <span class="token operator">></span> /etc/init.d/grafana <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/sbin/openrc-run

name="grafana"
description="Grafana Server"

command="/opt/grafana/bin/grafana server -- --config /opt/grafana/conf/config.ini"
pidfile=/data/grafana/run.pid
logfile=/data/grafana/<span class="token variable">$name</span>.log
workdir=/opt/grafana
user=grafana

depend() &#123;
  need net localmount
  after firewall
&#125;

start_pre() &#123;
  ebegin "Preparing to start <span class="token variable">$name</span>"
  eend <span class="token variable">$?</span>
&#125;

start() &#123;
  ebegin "Starting <span class="token variable">$name</span>"
  start-stop-daemon --start --quiet --background --name grafana --make-pidfile --pidfile <span class="token variable">$pidfile</span> --stdout <span class="token variable">$logfile</span> --chdir <span class="token variable">$workdir</span> --user <span class="token variable">$user</span> --exec <span class="token variable">$command</span>
  eend <span class="token variable">$?</span>
&#125;

stop() &#123;
  ebegin "Stopping <span class="token variable">$name</span>"
  start-stop-daemon --stop --quiet --pidfile <span class="token variable">$pidfile</span>
  if [ -e <span class="token variable">$pidfile</span> ]
    then rm <span class="token variable">$pidfile</span>
  fi
  eend <span class="token variable">$?</span>
&#125;

restart() &#123;
  ebegin "Restarting <span class="token variable">$name</span>"
  start-stop-daemon --stop --quiet --pidfile <span class="token variable">$pidfile</span>
  sleep 1
  start-stop-daemon --start --quiet --background --name grafana --make-pidfile --pidfile <span class="token variable">$pidfile</span> --stdout <span class="token variable">$logfile</span> --chdir <span class="token variable">$workdir</span> --user <span class="token variable">$user</span> --exec <span class="token variable">$command</span>
  eend <span class="token variable">$?</span>
&#125;
EOF</span>

<span class="token function">chown</span> <span class="token parameter variable">-R</span> grafana:grafana /opt/grafana
<span class="token function">chown</span> <span class="token parameter variable">-R</span> grafana:grafana /data/grafana
<span class="token function">chmod</span> +x /etc/init.d/grafana
rc-update <span class="token function">add</span> grafana default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Loki-搭建"><a href="#Loki-搭建" class="headerlink" title="Loki 搭建"></a>Loki 搭建</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /tmp
<span class="token function">unzip</span> loki-linux-amd64.zip
<span class="token function">mv</span> loki-linux-amd64 /opt/loki/loki

<span class="token function">cat</span> <span class="token operator">></span> /opt/loki/config.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
auth_enabled: false

server:
  http_listen_port: 3100

common:
  instance_addr: 0.0.0.0
  path_prefix: /opt/loki
  storage:
    filesystem:
      chunks_directory: /data/loki/chunks
      rules_directory: /data/loki/rules
  replication_factor: 1
  ring:
    kvstore:
      store: inmemory

schema_config:
  configs:
    - from: 2020-10-24
      store: tsdb
      object_store: filesystem
      schema: v13
      index:
        prefix: index_
        period: 24h

ruler:
  alertmanager_url: http://localhost:9093
EOF</span>

<span class="token function">cat</span> <span class="token operator">></span> /etc/init.d/loki <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/sbin/openrc-run

name="loki"
description="Grafana Loki"

command="/opt/loki/loki -- -config.file /opt/loki/config.yaml"
pidfile=/data/loki/run.pid
logfile=/data/loki/<span class="token variable">$name</span>.log
user=loki

depend() &#123;
  need net localmount
  after firewall
&#125;

start_pre() &#123;
  ebegin "Preparing to start <span class="token variable">$name</span>"
  eend <span class="token variable">$?</span>
&#125;

start() &#123;
  ebegin "Starting <span class="token variable">$name</span>"
  start-stop-daemon --start --quiet --background --name loki --make-pidfile --pidfile <span class="token variable">$pidfile</span> --stderr <span class="token variable">$logfile</span> --user <span class="token variable">$user</span> --exec <span class="token variable">$command</span>
  eend <span class="token variable">$?</span>
&#125;

stop() &#123;
  ebegin "Stopping <span class="token variable">$name</span>"
  start-stop-daemon --stop --quiet --pidfile <span class="token variable">$pidfile</span>
  if [ -e <span class="token variable">$pidfile</span> ]
    then rm <span class="token variable">$pidfile</span>
  fi
  eend <span class="token variable">$?</span>
&#125;

restart() &#123;
  ebegin "Restarting <span class="token variable">$name</span>"
  start-stop-daemon --stop --quiet --pidfile <span class="token variable">$pidfile</span>
  sleep 1
  start-stop-daemon --start --quiet --background --name loki --make-pidfile --pidfile <span class="token variable">$pidfile</span> --stderr <span class="token variable">$logfile</span> --user <span class="token variable">$user</span> --exec <span class="token variable">$command</span>
  eend <span class="token variable">$?</span>
&#125;
EOF</span>

<span class="token function">chown</span> <span class="token parameter variable">-R</span> loki:loki /opt/loki
<span class="token function">chown</span> <span class="token parameter variable">-R</span> loki:loki /data/loki
<span class="token function">chmod</span> +x /etc/init.d/loki
rc-update <span class="token function">add</span> loki default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Prometheus-搭建"><a href="#Prometheus-搭建" class="headerlink" title="Prometheus 搭建"></a>Prometheus 搭建</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /tmp
<span class="token function">tar</span> zxf prometheus-2.53.3.linux-amd64.tar.gz
<span class="token function">mv</span> prometheus-2.53.3.linux-amd64 /opt/prometheus

<span class="token function">cat</span> <span class="token operator">></span> /opt/prometheus/config.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - localhost:9093

rule_files:
  - "alert_rules.yml"

scrape_configs:
  - job_name: "EKS"
    static_configs:
      - targets: ["localhost:9090"]
        labels:
          instance: EKS

  - job_name: "JW"
    static_configs:
      - targets: ['192.168.10.2:9104']
        labels:
          instance: JW
EOF</span>

<span class="token function">cat</span> <span class="token operator">></span> /opt/prometheus/alert_rules.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
groups:
  - name: alert_rules
    rules:
      - alert: CPU使用告警
        expr: sum(avg(irate(node_cpu_seconds_total&#123;mode!='idle'&#125;[5m])) without (cpu)) by (instance) > 0.60
        for: 2m
        labels:
          level: warning
        annotations:
          summary: "主机 &#123;&#123; <span class="token variable">$labels</span>.instance &#125;&#125; CPU 使用过高"
          description: "&#123;&#123; <span class="token variable">$labels</span>.instance &#125;&#125; CPU 使用率超过 60% (current value: &#123;&#123; <span class="token variable">$value</span> &#125;&#125;)"
      - alert: CPU使用严重告警
        expr: (100 - (avg by (instance) (irate(node_cpu_seconds_total&#123;job=~".*",mode="idle"&#125;[5m])) * 100)) > 85
        for: 3m
        labels:
          level: serious
        annotations:
          summary: "主机 &#123;&#123; <span class="token variable">$labels</span>.instance &#125;&#125; CPU 使用高"
          description: "&#123;&#123; <span class="token variable">$labels</span>.instance &#125;&#125; CPU 使用率超过 85% (current value: &#123;&#123; <span class="token variable">$value</span> &#125;&#125;)"
      - alert: 内存使用告警
        expr: avg by(instance) <span class="token variable"><span class="token punctuation">((</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span>node_memory_MemFree_bytes <span class="token operator">+</span> node_memory_Buffers_bytes <span class="token operator">+</span> node_memory_Cached_bytes<span class="token punctuation">)</span> <span class="token operator">/</span> node_memory_MemTotal_bytes<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">70</span>
        for<span class="token operator">:</span> <span class="token number">2</span>m
        labels<span class="token operator">:</span>
          level<span class="token operator">:</span> warning
        annotations<span class="token operator">:</span>
          summary<span class="token operator">:</span> "主机 &#123;&#123; $labels.instance &#125;&#125; 内存使用过高"
          description<span class="token operator">:</span> "&#123;&#123;$labels.instance&#125;&#125;<span class="token operator">:</span> 内存使用率超过 <span class="token number">70</span><span class="token operator">%</span> <span class="token punctuation">(</span>current value is<span class="token operator">:</span> &#123;&#123; $value &#125;&#125;<span class="token punctuation">)</span>"
      <span class="token operator">-</span> alert<span class="token operator">:</span> 内存使用严重告警
        expr<span class="token operator">:</span> <span class="token punctuation">(</span>node_memory_MemTotal_bytes <span class="token operator">-</span> node_memory_MemAvailable_bytes<span class="token punctuation">)</span><span class="token operator">/</span>node_memory_MemTotal_bytes <span class="token operator">></span> <span class="token number">0.90</span>
        for<span class="token operator">:</span> <span class="token number">3</span>m
        labels<span class="token operator">:</span>
          level<span class="token operator">:</span> serious
        annotations<span class="token operator">:</span>
          summary<span class="token operator">:</span> "主机 &#123;&#123; $labels.instance &#125;&#125; 内存使用高"
          description<span class="token operator">:</span> "&#123;&#123; $labels.instance &#125;&#125; 内存使用率超过 <span class="token number">90</span><span class="token operator">%</span> <span class="token punctuation">(</span>current value<span class="token operator">:</span> &#123;&#123; $value &#125;&#125;<span class="token punctuation">)</span>"
      <span class="token operator">-</span> alert<span class="token operator">:</span> 硬盘使用告警
        expr<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> node_filesystem_free_bytes&#123;fstype<span class="token operator">!=</span>"rootfs"<span class="token punctuation">,</span>mountpoint<span class="token operator">!=</span>""<span class="token punctuation">,</span>mountpoint<span class="token operator">!</span><span class="token operator">~</span>"<span class="token operator">/</span><span class="token punctuation">(</span>run<span class="token operator">|</span>var<span class="token operator">|</span>sys<span class="token operator">|</span>dev<span class="token punctuation">)</span>.<span class="token operator">*</span>"&#125; <span class="token operator">/</span> node_filesystem_size_bytes<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">></span> <span class="token number">80</span>
        for<span class="token operator">:</span> <span class="token number">2</span>m
        labels<span class="token operator">:</span>
          level<span class="token operator">:</span> warning
        annotations<span class="token operator">:</span>
          summary<span class="token operator">:</span> "主机 &#123;&#123; $labels.instance &#125;&#125; 硬盘使用过高"
          description<span class="token operator">:</span> "&#123;&#123;$labels.instance&#125;&#125;<span class="token operator">:</span> 硬盘使用率超过 <span class="token number">80</span><span class="token operator">%</span> <span class="token punctuation">(</span>current value is<span class="token operator">:</span> &#123;&#123; $value &#125;&#125;<span class="token punctuation">)</span>"
      <span class="token operator">-</span> alert<span class="token operator">:</span> 硬盘使用严重告警
        expr<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> node_filesystem_free_bytes&#123;fstype<span class="token operator">!=</span>"rootfs"<span class="token punctuation">,</span>mountpoint<span class="token operator">!=</span>""<span class="token punctuation">,</span>mountpoint<span class="token operator">!</span><span class="token operator">~</span>"<span class="token operator">/</span><span class="token punctuation">(</span>run<span class="token operator">|</span>var<span class="token operator">|</span>sys<span class="token operator">|</span>dev<span class="token punctuation">)</span>.<span class="token operator">*</span>"&#125; <span class="token operator">/</span> node_filesystem_size_bytes<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">></span> <span class="token number">90</span>
        for<span class="token operator">:</span> <span class="token number">3</span>m
        labels<span class="token operator">:</span>
          level<span class="token operator">:</span> serious
        annotations<span class="token operator">:</span>
          summary<span class="token operator">:</span> "主机 &#123;&#123; $labels.instance &#125;&#125; 硬盘使用高"
          description<span class="token operator">:</span> "&#123;&#123;$labels.instance&#125;&#125;<span class="token operator">:</span> 硬盘使用率超过 <span class="token number">90</span><span class="token operator">%</span> <span class="token punctuation">(</span>current value is<span class="token operator">:</span> &#123;&#123; $value &#125;&#125;<span class="token punctuation">)</span>"
      <span class="token operator">-</span> alert<span class="token operator">:</span> 节点文件描述符告警
        expr<span class="token operator">:</span> avg by <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">(</span>node_filefd_allocated&#123;&#125; <span class="token operator">/</span> node_filefd_maximum&#123;&#125;<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">></span> <span class="token number">60</span>
        for<span class="token operator">:</span> <span class="token number">2</span>m
        labels<span class="token operator">:</span>
          level<span class="token operator">:</span> warning
        annotations<span class="token operator">:</span>
          summary<span class="token operator">:</span> "主机 &#123;&#123; $labels.instance &#125;&#125; 文件描述符使用高"
          description<span class="token operator">:</span> "&#123;&#123;$labels.instance&#125;&#125;<span class="token operator">:</span> 文件描述符使用超过 <span class="token number">60</span><span class="token operator">%</span> <span class="token punctuation">(</span>current value is<span class="token operator">:</span> &#123;&#123; $value &#125;&#125;<span class="token punctuation">)</span>"
      <span class="token operator">-</span> alert<span class="token operator">:</span> 节点平均负载告警
        expr<span class="token operator">:</span> avg by <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">(</span>node_load15&#123;&#125;<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">80</span>
        for<span class="token operator">:</span> <span class="token number">2</span>m
        labels<span class="token operator">:</span>
          level<span class="token operator">:</span> warning
        annotations<span class="token operator">:</span>
          summary<span class="token operator">:</span> "主机 &#123;&#123; $labels.instance &#125;&#125; <span class="token number">15</span> 分钟平均负载高"
          description<span class="token operator">:</span> "&#123;&#123;$labels.instance&#125;&#125;<span class="token operator">:</span> <span class="token number">15</span> 分钟平均负载超过 <span class="token number">80</span> <span class="token punctuation">(</span>current value is<span class="token operator">:</span> &#123;&#123; $value &#125;&#125;<span class="token punctuation">)</span>"
      <span class="token operator">-</span> alert<span class="token operator">:</span> 节点离线告警
        expr<span class="token operator">:</span> avg by <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">(</span>up&#123;&#125;<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
        for<span class="token operator">:</span> <span class="token number">2</span>m
        labels<span class="token operator">:</span>
          level<span class="token operator">:</span> warning
        annotations<span class="token operator">:</span>
          summary<span class="token operator">:</span> "主机 &#123;&#123;$labels.instance&#125;&#125; 当前离线"
          description<span class="token operator">:</span> "&#123;&#123;$labels.instance&#125;&#125;<span class="token operator">:</span> Node_Exporter 代理已断开 <span class="token punctuation">(</span>current value is<span class="token operator">:</span> &#123;&#123; $value &#125;&#125;<span class="token punctuation">)</span>"
      <span class="token operator">-</span> alert<span class="token operator">:</span> 节点进程阻塞告警
        expr<span class="token operator">:</span> avg by <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">(</span>node_procs_blocked&#123;&#125;<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">10</span>
        for<span class="token operator">:</span> <span class="token number">2</span>m
        labels<span class="token operator">:</span>
          level<span class="token operator">:</span> warning
        annotations<span class="token operator">:</span>
          summary<span class="token operator">:</span> "主机 &#123;&#123; $labels.instance &#125;&#125;  进程阻塞过高"
          description<span class="token operator">:</span> "&#123;&#123;$labels.instance&#125;&#125;<span class="token operator">:</span> 检测到进程阻塞超过 <span class="token number">10</span> <span class="token punctuation">(</span>current value is<span class="token operator">:</span> &#123;&#123; $value &#125;&#125;<span class="token punctuation">)</span>"
      <span class="token operator">-</span> alert<span class="token operator">:</span> 网络上传告警
        expr<span class="token operator">:</span>  avg by <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">(</span>floor<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_network_transmit_bytes_total&#123;&#125;[<span class="token number">2</span>m]<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token punctuation">))</span></span> > 40
        for: 1m
        labels:
          level: warning
        annotations:
          summary: "主机 &#123;&#123; <span class="token variable">$labels</span>.instance &#125;&#125; 网络上传过高"
          description: "&#123;&#123;<span class="token variable">$labels</span>.instance&#125;&#125;: 节点上传速率超过 40Mbps/s (current value is: &#123;&#123; <span class="token variable">$value</span> &#125;&#125;Mbps/s)"
      - alert: 网络下载告警
        expr:  avg by (instance) (floor(irate(node_network_receive_bytes_total&#123;&#125;[2m]) / 1024 / 1024 * 8 )) > 40
        for: 1m
        labels:
          level: warning
        annotations:
          summary: "Instance &#123;&#123; <span class="token variable">$labels</span>.instance &#125;&#125; 网络下载过高"
          description: "&#123;&#123;<span class="token variable">$labels</span>.instance&#125;&#125;: 节点下载速率超过 40Mbps/s (current value is: &#123;&#123; <span class="token variable">$value</span> &#125;&#125;Mbps/s)"
      - alert: 磁盘读取告警
        expr: avg by (instance) (floor(irate(node_disk_read_bytes_total&#123;&#125;[2m]) / 1024 )) > 5000
        for: 10m
        labels:
          level: warning
        annotations:
          summary: "主机 &#123;&#123; <span class="token variable">$labels</span>.instance &#125;&#125; 磁盘读取速率过高"
          description: "&#123;&#123;<span class="token variable">$labels</span>.instance&#125;&#125;: 节点磁盘读取速率超过 5000KB/s (current value is: &#123;&#123; <span class="token variable">$value</span> &#125;&#125;KB/s)"
      - alert: 磁盘写入告警
        expr: avg by (instance) (floor(irate(node_disk_written_bytes_total&#123;&#125;[2m]) / 1024 / 1024 )) > 200
        for: 2m
        labels:
          level: warning
        annotations:
          summary: "主机 &#123;&#123; <span class="token variable">$labels</span>.instance &#125;&#125; 磁盘写入速率过高"
          description: "&#123;&#123;<span class="token variable">$labels</span>.instance&#125;&#125;: 节点磁盘写入速率超过 20MB/s (current value is: &#123;&#123; <span class="token variable">$value</span> &#125;&#125;MB/s)"
EOF</span>

<span class="token function">cat</span> <span class="token operator">></span> /etc/init.d/prometheus <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/sbin/openrc-run

name="prometheus"
description="Prometheus Server"

command="/opt/prometheus/prometheus -- --config.file=/opt/prometheus/config.yml --web.enable-remote-write-receiver --storage.tsdb.path=/opt/prometheus/data"
pidfile=/data/prometheus/run.pid
logfile=/data/prometheus/<span class="token variable">$name</span>.log
user=prometheus

depend() &#123;
  need net localmount
  after firewall
&#125;

start_pre() &#123;
  ebegin "Preparing to start <span class="token variable">$name</span>"
  eend <span class="token variable">$?</span>
&#125;

start() &#123;
  ebegin "Starting <span class="token variable">$name</span>"
  start-stop-daemon --start --quiet --background --name prometheus --make-pidfile --pidfile <span class="token variable">$pidfile</span> --stderr <span class="token variable">$logfile</span> --user <span class="token variable">$user</span> --exec <span class="token variable">$command</span>
  eend <span class="token variable">$?</span>
&#125;

stop() &#123;
  ebegin "Stopping <span class="token variable">$name</span>"
  start-stop-daemon --stop --quiet --pidfile <span class="token variable">$pidfile</span>
  if [ -e <span class="token variable">$pidfile</span> ]
    then rm <span class="token variable">$pidfile</span>
  fi
  eend <span class="token variable">$?</span>
&#125;

restart() &#123;
  ebegin "Restarting <span class="token variable">$name</span>"
  start-stop-daemon --stop --quiet --pidfile <span class="token variable">$pidfile</span>
  sleep 1
  start-stop-daemon --start --quiet --background --name prometheus --make-pidfile --pidfile <span class="token variable">$pidfile</span> --stderr <span class="token variable">$logfile</span> --user <span class="token variable">$user</span> --exec <span class="token variable">$command</span>
  eend <span class="token variable">$?</span>
&#125;
EOF</span>

<span class="token function">chown</span> <span class="token parameter variable">-R</span> prometheus:prometheus /opt/prometheus
<span class="token function">chown</span> <span class="token parameter variable">-R</span> prometheus:prometheus /data/prometheus
<span class="token function">chmod</span> +x /etc/init.d/prometheus
rc-update <span class="token function">add</span> prometheus default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="AlertManager-搭建"><a href="#AlertManager-搭建" class="headerlink" title="AlertManager 搭建"></a>AlertManager 搭建</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> zxf alertmanager-0.27.0.linux-amd64.tar.gz
<span class="token function">mv</span> alertmanager-0.27.0.linux-amd64 /opt/alertmanager

<span class="token function">cat</span> <span class="token operator">></span> /opt/alertmanager/config.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1m
  receiver: 'dingtalk'

receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://127.0.0.1:5001/'
  - name: 'dingtalk'
    webhook_configs:
      - url: http://localhost:8060/dingtalk/webhook_mention_users/send
        send_resolved: true

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'dev', 'instance']
EOF</span>

<span class="token function">cat</span> <span class="token operator">></span> /etc/init.d/alertmanager <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/sbin/openrc-run

name="alertmanager"
description="Prometheus AlertManager"

command="/opt/alertmanager/alertmanager -- --config.file=/opt/alertmanager/config.yml --storage.path=/opt/alertmanager/data"
pidfile=/data/alertmanager/run.pid
logfile=/data/alertmanager/<span class="token variable">$name</span>.log
user=alertmanager

depend() &#123;
  need net localmount
  after firewall
&#125;

start_pre() &#123;
  ebegin "Preparing to start <span class="token variable">$name</span>"
  eend <span class="token variable">$?</span>
&#125;

start() &#123;
  ebegin "Starting <span class="token variable">$name</span>"
  start-stop-daemon --start --quiet --background --name alertmanager --make-pidfile --pidfile <span class="token variable">$pidfile</span> --stderr <span class="token variable">$logfile</span> --user <span class="token variable">$user</span> --exec <span class="token variable">$command</span>
  eend <span class="token variable">$?</span>
&#125;

stop() &#123;
  ebegin "Stopping <span class="token variable">$name</span>"
  start-stop-daemon --stop --quiet --pidfile <span class="token variable">$pidfile</span>
  if [ -e <span class="token variable">$pidfile</span> ]
    then rm <span class="token variable">$pidfile</span>
  fi
  eend <span class="token variable">$?</span>
&#125;

restart() &#123;
  ebegin "Restarting <span class="token variable">$name</span>"
  start-stop-daemon --stop --quiet --pidfile <span class="token variable">$pidfile</span>
  sleep 1
  start-stop-daemon --start --quiet --background --name alertmanager --make-pidfile --pidfile <span class="token variable">$pidfile</span> --stderr <span class="token variable">$logfile</span> --user <span class="token variable">$user</span> --exec <span class="token variable">$command</span>
  eend <span class="token variable">$?</span>
&#125;
EOF</span>

<span class="token function">chown</span> <span class="token parameter variable">-R</span> alertmanager:alertmanager /opt/alertmanager
<span class="token function">chown</span> <span class="token parameter variable">-R</span> alertmanager:alertmanager /data/alertmanager
<span class="token function">chmod</span> +x /etc/init.d/alertmanager
rc-update <span class="token function">add</span> alertmanager default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="钉钉告警搭建"><a href="#钉钉告警搭建" class="headerlink" title="钉钉告警搭建"></a>钉钉告警搭建</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> zxf prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz
<span class="token function">mv</span> prometheus-webhook-dingtalk-2.1.0.linux-amd64 /opt/dingtalk
<span class="token function">mv</span> /opt/dingtalk/prometheus-webhook-dingtalk /opt/dingtalk/dingtalk

<span class="token function">cat</span> <span class="token operator">></span> /opt/dingtalk/config.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
timeout: 5s

templates:
  - /opt/dingtalk/template.tmpl

targets:
  webhook_robot:
    url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxx # 这里更换为自己的钉钉机器人api
EOF</span>

<span class="token function">cat</span> <span class="token operator">></span> /opt/dingtalk/template.tmpl <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
&#123;&#123; define "__subject" &#125;&#125;
[&#123;&#123; .Status | toUpper &#125;&#125;&#123;&#123; if eq .Status "firing" &#125;&#125;:&#123;&#123; .Alerts.Firing | len &#125;&#125;&#123;&#123; end &#125;&#125;]
&#123;&#123; end &#125;&#125;

&#123;&#123; define "__alert_list" &#125;&#125;&#123;&#123; range . &#125;&#125;
---
&#123;&#123; if .Labels.owner &#125;&#125;@&#123;&#123; .Labels.owner &#125;&#125;&#123;&#123; end &#125;&#125;

**告警主题**: &#123;&#123; .Annotations.summary &#125;&#125;

**告警类型**: &#123;&#123; .Labels.alertname &#125;&#125;

**告警级别**: &#123;&#123; .Labels.severity &#125;&#125; 

**告警主机**: &#123;&#123; .Labels.instance &#125;&#125; 

**告警信息**: &#123;&#123; index .Annotations "description" &#125;&#125;

**告警时间**: &#123;&#123; dateInZone "2006.01.02 15:04:05" (.StartsAt) "Asia/Shanghai" &#125;&#125;

&#123;&#123; .Labels.Users &#125;&#125;
&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;

&#123;&#123; define "__resolved_list" &#125;&#125;&#123;&#123; range . &#125;&#125;
---
&#123;&#123; if .Labels.owner &#125;&#125;@&#123;&#123; .Labels.owner &#125;&#125;&#123;&#123; end &#125;&#125;

**告警主题**: &#123;&#123; .Annotations.summary &#125;&#125;

**告警类型**: &#123;&#123; .Labels.alertname &#125;&#125; 

**告警级别**: &#123;&#123; .Labels.severity &#125;&#125;

**告警主机**: &#123;&#123; .Labels.instance &#125;&#125;

**告警信息**: &#123;&#123; index .Annotations "description" &#125;&#125;

**告警时间**: &#123;&#123; dateInZone "2006.01.02 15:04:05" (.StartsAt) "Asia/Shanghai" &#125;&#125;

**恢复时间**: &#123;&#123; dateInZone "2006.01.02 15:04:05" (.EndsAt) "Asia/Shanghai" &#125;&#125;

&#123;&#123; .Labels.Users &#125;&#125;
&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;


&#123;&#123; define "default.title" &#125;&#125;
&#123;&#123; template "__subject" . &#125;&#125;
&#123;&#123; end &#125;&#125;

&#123;&#123; define "default.content" &#125;&#125;
&#123;&#123; if gt (len .Alerts.Firing) 0 &#125;&#125;
&lt;font color="#FF0000" size="8" face="黑体">**====侦测到&#123;&#123; .Alerts.Firing | len  &#125;&#125;个故障====**&lt;/font>
&#123;&#123; template "__alert_list" .Alerts.Firing &#125;&#125;
---
&#123;&#123; end &#125;&#125;

&#123;&#123; if gt (len .Alerts.Resolved) 0 &#125;&#125;
&lt;font color="#00FF00" size="8" face="黑体">**====恢复&#123;&#123; .Alerts.Resolved | len  &#125;&#125;个故障====**&lt;/font>
&#123;&#123; template "__resolved_list" .Alerts.Resolved &#125;&#125;
&#123;&#123; end &#125;&#125;
&#123;&#123; end &#125;&#125;


&#123;&#123; define "ding.link.title" &#125;&#125;&#123;&#123; template "default.title" . &#125;&#125;&#123;&#123; end &#125;&#125;
&#123;&#123; define "ding.link.content" &#125;&#125;&#123;&#123; template "default.content" . &#125;&#125;&#123;&#123; end &#125;&#125;
&#123;&#123; template "default.title" . &#125;&#125;
&#123;&#123; template "default.content" . &#125;&#125;
EOF</span>

<span class="token function">cat</span> <span class="token operator">></span> /etc/init.d/dingtalk <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/sbin/openrc-run

name="dingtalk"
description="Prometheus Webhook DingTalk"

command="/opt/dingtalk/dingtalk -- --config.file=/opt/dingtalk/config.yml --web.listen-address=":8060" --web.enable-ui --web.enable-lifecycle --log.format=json"
pidfile=/data/dingtalk/run.pid
logfile=/data/dingtalk/<span class="token variable">$name</span>.log
user=dingtalk

depend() &#123;
  need net localmount
  after firewall
&#125;

start_pre() &#123;
  ebegin "Preparing to start <span class="token variable">$name</span>"
  eend <span class="token variable">$?</span>
&#125;

start() &#123;
  ebegin "Starting <span class="token variable">$name</span>"
  start-stop-daemon --start --quiet --background --name dingtalk --make-pidfile --pidfile <span class="token variable">$pidfile</span> --stderr <span class="token variable">$logfile</span> --user <span class="token variable">$user</span> --exec <span class="token variable">$command</span>
  eend <span class="token variable">$?</span>
&#125;

stop() &#123;
  ebegin "Stopping <span class="token variable">$name</span>"
  start-stop-daemon --stop --quiet --pidfile <span class="token variable">$pidfile</span>
  if [ -e <span class="token variable">$pidfile</span> ]
    then rm <span class="token variable">$pidfile</span>
  fi
  eend <span class="token variable">$?</span>
&#125;

restart() &#123;
  ebegin "Restarting <span class="token variable">$name</span>"
  start-stop-daemon --stop --quiet --pidfile <span class="token variable">$pidfile</span>
  sleep 1
  start-stop-daemon --start --quiet --background --name dingtalk --make-pidfile --pidfile <span class="token variable">$pidfile</span> --stderr <span class="token variable">$logfile</span> --user <span class="token variable">$user</span> --exec <span class="token variable">$command</span>
  eend <span class="token variable">$?</span>
&#125;
EOF</span>

<span class="token function">chown</span> <span class="token parameter variable">-R</span> dingtalk:dingtalk /opt/dingtalk
<span class="token function">chown</span> <span class="token parameter variable">-R</span> dingtalk:dingtalk /data/dingtalk
<span class="token function">chmod</span> +x /etc/init.d/dingtalk
rc-update <span class="token function">add</span> dingtalk default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Promtail-搭建"><a href="#Promtail-搭建" class="headerlink" title="Promtail 搭建"></a>Promtail 搭建</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">unzip</span> promtail-linux-amd64.zip
<span class="token function">mv</span> promtail-linux-amd64 /opt/promtail/promtail

<span class="token function">cat</span> <span class="token operator">></span> /opt/promtail/config.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /data/promtail/positions.yaml

clients:
  - url: http://localhost:3100/loki/api/v1/push

scrape_configs:
- job_name: EKS
  static_configs:
  - targets:
      - localhost
    labels:
      job: "System Logs|EKS"
      __path__: /var/log/messages
  - targets:
      - localhost
    labels:
      job: "Soft Logs|EKS"
      __path__: /data/*/*log
EOF</span>

<span class="token function">cat</span> <span class="token operator">></span> /etc/init.d/promtail <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/sbin/openrc-run

name="promtail"
description="Promtail"

command="/opt/promtail/promtail -- --config.file=/opt/promtail/config.yaml"
pidfile=/data/promtail/run.pid
logfile=/data/promtail/<span class="token variable">$name</span>.log

depend() &#123;
  need net localmount
  after firewall
&#125;

start_pre() &#123;
  ebegin "Preparing to start <span class="token variable">$name</span>"
  eend <span class="token variable">$?</span>
&#125;

start() &#123;
  ebegin "Starting <span class="token variable">$name</span>"
  start-stop-daemon --start --quiet --background --name promtail --make-pidfile --pidfile <span class="token variable">$pidfile</span> --stderr <span class="token variable">$logfile</span> --exec <span class="token variable">$command</span>
  eend <span class="token variable">$?</span>
&#125;

stop() &#123;
  ebegin "Stopping <span class="token variable">$name</span>"
  start-stop-daemon --stop --quiet --pidfile <span class="token variable">$pidfile</span>
  if [ -e <span class="token variable">$pidfile</span> ]
    then rm <span class="token variable">$pidfile</span>
  fi
  eend <span class="token variable">$?</span>
&#125;

restart() &#123;
  ebegin "Restarting <span class="token variable">$name</span>"
  start-stop-daemon --stop --quiet --pidfile <span class="token variable">$pidfile</span>
  sleep 1
  start-stop-daemon --start --quiet --background --name promtail --make-pidfile --pidfile <span class="token variable">$pidfile</span> --stderr <span class="token variable">$logfile</span> --exec <span class="token variable">$command</span>
  eend <span class="token variable">$?</span>
&#125;
EOF</span>

<span class="token function">chmod</span> +x /etc/init.d/promtail
rc-update <span class="token function">add</span> promtail default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动各项服务"><a href="#启动各项服务" class="headerlink" title="启动各项服务"></a>启动各项服务</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">service</span> grafana start
<span class="token function">service</span> loki start
<span class="token function">service</span> prometheus start
<span class="token function">service</span> alertmanager start
<span class="token function">service</span> dingtalk start
<span class="token function">service</span> promtail start<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="客户端搭建"><a href="#客户端搭建" class="headerlink" title="客户端搭建"></a>客户端搭建</h2><h3 id="Promtail-搭建-1"><a href="#Promtail-搭建-1" class="headerlink" title="Promtail 搭建"></a>Promtail 搭建</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /tmp
<span class="token function">wget</span> <span class="token parameter variable">-c</span> https://github.com/grafana/loki/releases/download/v3.3.1/promtail-linux-amd64.zip
<span class="token function">unzip</span> promtail-linux-amd64.zip
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /opt/promtail
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/promtail
<span class="token function">mv</span> promtail-linux-amd64 /opt/promtail/promtail

<span class="token function">cat</span> /opt/promtail/config.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /data/promtail/positions.yaml

clients:
  - url: http://192.168.10.1:3100/loki/api/v1/push

scrape_configs:
- job_name: MongoDB
  static_configs:
  - targets:
      - localhost
    labels:
      job: "System Logs|MongoDB"
      __path__: /var/log/*log
  - targets:
      - localhost
    labels:
      job: "MongoDB Logs|MongoDB"
      __path__: /var/log/mongodb/*log
EOF</span>

<span class="token function">cat</span> <span class="token operator">></span> /etc/systemd/system/promtail.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[Unit]
Description=Promtail
Documentation=https://github.com/grafana/loki
After=network.target

[Service]
Type=simple
ExecStart=/opt/promtail/promtail --config.file=/opt/promtail/config.yaml
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF</span>

systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> promtail.service
systemctl start promtail.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Node-Exporter-搭建"><a href="#Node-Exporter-搭建" class="headerlink" title="Node Exporter 搭建"></a>Node Exporter 搭建</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /tmp
<span class="token function">wget</span> <span class="token parameter variable">-c</span> https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz
<span class="token function">tar</span> zxf node_exporter-1.8.2.linux-amd64.tar.gz

<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/exporter
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /opt/exporter
<span class="token function">mv</span> node_exporter-1.8.2.linux-amd64 /opt/exporter
<span class="token function">mv</span> /opt/exporter/node_exporter /opt/exporter/exporter

<span class="token function">useradd</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-M</span> exporter
<span class="token function">chown</span> <span class="token parameter variable">-R</span> exporter:exporter /data/exporter
<span class="token function">chown</span> <span class="token parameter variable">-R</span> exporter:exporter /opt/exporter

<span class="token function">cat</span> <span class="token operator">></span> /etc/systemd/system/exporter.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[Unit]
Description=Prometheus Node Exporter
After=network.target
 
[Service]
Restart=on-failure
ExecStart=/opt/exporter/exporter --web.listen-address=:9104
 
[Install]
WantedBy=multi-user.target
EOF</span>

systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> exporter.service
systemctl start exporter.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="面板使用"><a href="#面板使用" class="headerlink" title="面板使用"></a>面板使用</h2><p>打开 Grafana 面板并登陆：<code>http://192.168.10.1:3000</code>，默认账号密码为 <code>admin/admin</code></p><p><img src="https://cdn.free.gd/images/2024/12/01.5fknl4ex9c.avif" alt="01"></p><p>在个人资料中修改语言为中文</p><p><img src="https://cdn.free.gd/images/2024/12/02.73u0ib57fk.avif" alt="02"></p><p><img src="https://cdn.free.gd/images/2024/12/03.51e7u96me9.avif" alt="03"></p><p>找到左侧的数据源，并添加 Loki 及 Prometheus 两种数据源</p><p>Loki 的链接地址是 <a target="_blank" rel="noopener" href="http://localhost:3100/">http://localhost:3100</a></p><p><img src="https://cdn.free.gd/images/2024/12/04.4ckya8j3dt.avif" alt="04"></p><p>Prometheus 的链接地址是 <a target="_blank" rel="noopener" href="http://localhost:9090/">http://localhost:9090</a></p><p><img src="https://cdn.free.gd/images/2024/12/05.2dorjwdl29.avif" alt="05"></p><p>找到仪表板，添加一个新的仪表板</p><p><img src="https://cdn.free.gd/images/2024/12/06.60ub7f9dk2.avif" alt="06"></p><p><img src="https://cdn.free.gd/images/2024/12/07.5q7he9u5eq.avif" alt="07"></p><p>点击 “导入仪表板” —— “Discard”</p><p><img src="https://cdn.free.gd/images/2024/12/08.1ovhzvq21u.avif" alt="08"></p><p>在输入框中输入仪表板的编号后点击加载，加载完成后选择自己的 Prometheus 数据源，这里我用的是 8919，如果想要更多仪表板，可以看这里：<a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards">https://grafana.com/grafana/dashboards</a></p><p><img src="https://cdn.free.gd/images/2024/12/09.175gbaoogz.avif" alt="09"></p><p>可在面板中看到监控主机的详细情况</p><p><img src="https://cdn.free.gd/images/2024/12/10.esktk82qr.avif" alt="10"></p><p>在左侧的 Logs 中可以查看日志信息，当然，还有一些诸如日志查询、搜索等功能，可以自己慢慢发现</p><p><img src="https://cdn.free.gd/images/2024/12/11.7pcy4lxb8.avif" alt="11"></p></article><section class="jump-container is-flex is-justify-content-space-between my-6"><em></em><a class="button is-default" href="/openwrt-openclash-adguardhome.html" title="OpenWrt中OpenClash与AdGuardHome结合"><span class="has-text-weight-semibold">下一页: OpenWrt中OpenClash与AdGuardHome结合</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="coolbie/Comments" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/ylqjgm"><i class="iconfont icon-github"></i></a></section><p><span>Copyright ©</span> <span>康诺 2024</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top:2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer="defer" src="https://buttons.github.io/buttons.js"></script><script src="//unpkg.com/jquery@3.6.1/dist/jquery.min.js"></script><script src="//unpkg.com/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>